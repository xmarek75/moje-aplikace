<template>
  <q-page class="page-container">
    <!-- 🔹 Tlačítko "Transcription" s menu -->
    <div class="transcription-button-container">
      <q-btn label="Transcription" color="primary" icon="article" @click="openTranscriptionMenu" class=TranscriptionButton>
        <q-menu>
          <q-list>
            <q-item clickable v-close-popup @click="openModelDialog">
              <q-item-section>Choose Different Model</q-item-section>
            </q-item>
            <q-item clickable v-close-popup @click="toggleSubtitleMode">
              <q-item-section>Subtitle Mode</q-item-section>
            </q-item>
            <q-item clickable v-close-popup @click="downloadTranscription">
              <q-item-section>Download</q-item-section>
            </q-item>
          </q-list>
        </q-menu>
      </q-btn>
    </div>
    <q-card class="main-card">
      <q-card-section class="header">
        <div class="title-container">
          <h5>{{ transcription.media?.title }}</h5>
          <q-btn flat dense icon="edit" class="edit-icon" @click="openRenameDialog"/>
        </div>
      </q-card-section>

      <div class="content-container">
        <!-- Levá část: Textová transkripce -->
        <div class="transcription-container">
          <span v-for="segment in transcription.segments" :key="segment.start">
            <span 
              v-for="(word, index) in segment.words" 
              :key="word.start"
              :class="[getConfidenceClass(word.confidence), { 'highlighted': isHighlighted(word.start) }]"
              contenteditable="true"
              @click="selectWord(word)"
              @blur="updateWordText($event, word, index, segment.words)" 
            >
              {{ word.word }}
            </span>
            <span> </span>
          </span>
        </div>
        <!-- Pravá část: Detaily slova -->
        <div class="details-container" v-if="selectedWord">
          <div class="details-box">
            <div class="word">
              <strong>{{ selectedWord.word }}</strong>
            </div>
            <div class="info">
              <span>🕒 {{ formatTime(selectedWord.start) }} - {{ formatTime(selectedWord.end) }}</span>
              <span>🎯 Confidence: {{ (selectedWord.confidence * 100).toFixed(1) }}%</span>
            </div>
            <q-btn label="✔ Confirm" color="primary" @click="confirmCorrectness" class="confirm-btn"/>
          </div>
        </div>
      </div>

      <!-- Akční tlačítka -->
      <q-card-actions align="right">
        <q-btn label="Save" color="primary" @click="saveTranscription" />
        <q-btn label="Cancel" color="negative" flat @click="cancelEdit" />
      </q-card-actions>
    </q-card>

    <!-- Audio přehrávač pevně připojený dole -->
    <div v-if="transcription.media" class="audio-container">
      <audio 
        ref="audioPlayer"
        controls 
        :src="getMediaPath(transcription.media.file_path)"
        class="audio-player"
        @timeupdate="updateActiveWord"
      >          
      </audio>
      <!-- Výběr rychlosti přehrávání -->
      <q-select
        v-model="playbackRate"
        :options="speedOptions"
        label="Speed"
        dense
        outlined
        class="speed-select"
        @update:model-value="changePlaybackRate"
      />
    </div>
    <!-- Pop-up okno pro přejmenování -->
    <q-dialog v-model="renameDialogVisible">
      <q-card class="rename-card">
        <q-card-section>
          <h5 class="rename-title">Rename Transcription</h5>
          <q-input v-model="newTitle" label="New Title" autofocus />
        </q-card-section>
        <q-card-actions align="right">
          <q-btn label="Cancel" color="negative" flat @click="renameDialogVisible = false" />
          <q-btn label="Save" color="primary" @click="renameMedia"/>
        </q-card-actions>
      </q-card>
    </q-dialog>
    <!-- Pop-up okno pro zmenu modelu -->
    <q-dialog v-model="modelDialogVisible">
      <q-card class="model-card">
        <q-card-section class="model-header">
          <h5 class="model-title">Choose Model</h5>
        </q-card-section>

        <q-card-section class="model-body">
          <q-option-group
            v-model="selectedModel"
            :options="models"
            type="radio"
            class="model-options"
          />
        </q-card-section>

        <q-card-actions align="right" class="model-actions">
          <q-btn label="Cancel" color="negative" flat @click="modelDialogVisible = false" />
          <q-btn label="Save" color="primary" @click="changeModel"/>
        </q-card-actions>
      </q-card>
    </q-dialog>
  </q-page>
</template>


<script setup>
import { ref, onMounted } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import { api } from 'boot/axios';

const route = useRoute();
const router = useRouter();
const transcription = ref({ text: "", segments: [], media: null,id: null, model: '' });
const selectedWord = ref(null);
const audioPlayer = ref(null);
const activeWordStart = ref(null); // Aktuálně zvýrazněné slovo
let saveTimeout = null; // ✅ Uchovává timeout pro debounce efekt
const renameDialogVisible = ref(false); //viditelnost rename dialogu
const modelDialogVisible = ref(false); //viditelnost model dialogu
const newTitle = ref(""); //uchovava novy nazev
const selectedModel = ref(""); //novy model
const playbackRate = ref(1.0); //defaultni rychlost prehravani
const speedOptions = [0.5, 0.75, 1.0, 1.25, 1.5, 2.0]; //moznosti rychlosti prehravani

// ✅ Tabulka sloupců pro vybrané slovo
const columns = [
  { name: "word", label: "Word", align: "left", field: row => row.word },
  { name: "start", label: "Start Time", align: "left", field: row => formatTime(row.start) },
  { name: "end", label: "End Time", align: "left", field: row => formatTime(row.end) },
  { name: "confidence", label: "Confidence", align: "left", field: row => (row.confidence * 100).toFixed(1) + "%" }
];
//tabulka modelu
const models = [
  { label: 'Model A', value: 'model_a' },
  { label: 'Model B', value: 'model_b' },
  { label: 'Model C', value: 'model_c' }
]
// ✅ Načtení transkripce z API
const fetchTranscription = async () => {
  try {
    const response = await api.get(`/transcriptions/${route.params.id}`, {
      headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
    });
    console.log("✅ Transcription data received:", response.data);
    transcription.value = response.data || { text: '', segments: [], media: null, id: null, model: ''}; // ✅ Oprava chybějících dat
  } catch (error) {
    console.error("Chyba při načítání transkripce:", error);
  }
};

// ✅ Automatické ukládání (debounce 1 sekunda)
const autoSaveTranscription = () => {
  if (saveTimeout) clearTimeout(saveTimeout);
  saveTimeout = setTimeout(async () => {
    try {
      await api.put(`/transcriptions/${route.params.id}`, 
        transcription.value,  
        { headers: { Authorization: `Bearer ${localStorage.getItem("token")}` } }
      );
      console.log("✅ Automaticky uloženo!");
    } catch (error) {
      console.error("Chyba při automatickém ukládání:", error);
    }
  }, 1000);
};

// ✅ Funkce pro manuální uložení
const saveTranscription = async () => {
  try {
    await api.put(`/transcriptions/${route.params.id}`, 
      transcription.value,  
      { headers: { Authorization: `Bearer ${localStorage.getItem("token")}` } }
    );
    router.push("/home");
  } catch (error) {
    console.error("Chyba při ukládání transkripce:", error);
  }
};

// ✅ Funkce pro návrat zpět
const cancelEdit = () => {
  router.push("/home");
};

// ✅ Funkce pro formátování času
const formatTime = (time) => {
  if (time === null || time === undefined) return "N/A";
  const minutes = Math.floor(time / 60);
  const seconds = (time % 60).toFixed(2);
  return `${minutes}:${seconds}`;
};

// ✅ Ověření, zda je slovo zvýrazněné
const isHighlighted = (wordStart) => {
  return activeWordStart.value === wordStart;
};

// ✅ Určuje barvu podle confidence
const getConfidenceClass = (confidence) => {
  if (confidence < 0.7) return "text-red";
  return "text-black";
};

// ✅ Výběr slova pro detaily, upravi cas v audiplayeru, nastavi slovo na aktivni
const selectWord = (word) => {
  selectedWord.value = word;
  if (audioPlayer.value) {
    audioPlayer.value.currentTime = word.start; // Posun přehrávače
  }
  activeWordStart.value = word.start; //zvyraznit slovo
};

// ✅ Aktualizace aktivního slova při přehrávání
const updateActiveWord = () => {
  if (!audioPlayer.value) return;

  const currentTime = audioPlayer.value.currentTime;
  let foundWord = null;

  transcription.value.segments.forEach(segment => {
    segment.words.forEach(word => {
      if (
        currentTime >= (word.start - 0.1) && 
        currentTime <= (word.end ? word.end + 0.1 : word.start + 0.5)
      ) {
        foundWord = word;
      }
    });
  });

  if (foundWord) {
    activeWordStart.value = foundWord.start;
    selectedWord.value = foundWord; // ✅ Zajištění, že se zobrazí tabulka
  }
};

// ✅ Potvrzení správnosti slova
const confirmCorrectness = () => {
  if (selectedWord.value) {
    selectedWord.value.confidence = 1.0;
    autoSaveTranscription(); // ✅ Automaticky uloží potvrzení
  }
};

// ✅ Aktualizace textu slova (bez ztráty kurzoru)
const updateWordText = (event, word, index, wordsArray) => {
  word.word = event.target.innerText;
  autoSaveTranscription(); // ✅ Automaticky uloží změnu po 1s
};

const getMediaPath = (path) => {
  if (!path.startsWith("http")) {
    return `http://localhost:8000${path}`; // ✅ Oprava URL pro Vue
  }
  return path;
};

const openRenameDialog = () => {
  newTitle.value = transcription.value.media?.title || "";
  renameDialogVisible.value = true;
};

//prejmenovani nazvu media
const renameMedia = async () => {
  if (!newTitle.value.trim()) return;
  
  try {
    await api.put(`/media/${transcription.value.media.id}/rename`, 
      { title: newTitle.value },
      { headers: { Authorization: `Bearer ${localStorage.getItem("token")}` } }
    );

    transcription.value.media.title = newTitle.value;
    renameDialogVisible.value = false;
  } catch (error) {
    console.error("Chyba při přejmenování:", error);
  }
};

//zmena rychlosti prehravani
const changePlaybackRate = () => {
  if (audioPlayer.value) {
    audioPlayer.value.playbackRate = playbackRate.value;
  }
};

//zmena modelu
const changeModel = async () => {
  try {
    if (!selectedModel.value) {
      console.error("❌ Žádný model nebyl vybrán!");
      return;
    }

    await api.put(`/transcriptions/${transcription.value.id}/change-model`, 
      { model: selectedModel.value },  //
      { headers: { Authorization: `Bearer ${localStorage.getItem("token")}` } }
    );

    console.log(`✅ Model změněn na: ${selectedModel.value}`);
    modelDialogVisible.value = false; // ✅ Zavřít dialog po úspěšné změně
  } catch (error) {
    console.error("❌ Chyba při změně modelu:", error);
  }
  cancelEdit()
};


//otevreni dialogu pro zmenu modelu
const openModelDialog = () => {
  selectedModel.value = transcription.value.model || '';
  modelDialogVisible.value = true;
};

onMounted(fetchTranscription);
</script>

<style scoped>
/* 🔹 Hlavní kontejner stránky */
.page-container {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  height: 100vh;
  padding-bottom: 80px; /* Zajistit místo pro přehrávač */
}

/* 🔹 Hlavní karta */
.main-card {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  width: 90%;
  margin: auto;
  padding: 20px;
  max-height: 80vh; /* Zabrání přetékání mimo viewport */
  overflow: hidden;
}

/* 🔹 Kontejner pro obsah - transkripce a detaily vedle sebe */
.content-container {
  display: flex;
  flex-grow: 1;
  overflow: hidden;
}

/* 🔹 Levá část - Transkripce */
.transcription-container {
  flex: 4;
  background: #f5f5f5;
  padding: 10px;
  border-radius: 5px;
  max-height: 60vh; /* Umožní skrolování */
  overflow-y: auto;
  margin-right: 10px;
}

/* 🔹 Pevně připojený audio přehrávač dole */
.audio-container {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: white;
  padding: 10px;
  box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  display: flex;
  justify-content: center;
}

/* 🔹 Přehrávač */
.audio-player {
  width: 100%;
  max-width: 800px;
  padding: 5px;
  border-radius: 10px;
}

/* 🔹 Zvýraznění aktivního slova */
.highlighted {
  background-color: yellow;
  font-weight: bold;
}

/* 🔹 Kontejner pro detaily */
.details-container {
  flex: 1;
  background: #ffffff;
  padding: 10px;
  border-radius: 8px;
  max-height: 60vh;
  overflow-y: auto;
  border-left: 2px solid #ddd; /* Oddělení od transkripce */
  display: flex;
  align-items: center;
  justify-content: center;
 
}

/* 🔹 Box s informacemi */
.details-box {
  background: #f9f9f9;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
  width: 100%;
  max-width: 300px;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* 🔹 Zvýrazněné slovo */
.details-box .word {
  font-size: 1.5rem;
  font-weight: bold;
  color: #333;
  margin-bottom: 5px;
}

/* 🔹 Informace pod slovem */
.details-box .info {
  font-size: 0.9rem;
  color: #666;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

/* 🔹 Tlačítko pro potvrzení */
.confirm-btn {
  margin-top: 10px;
  width: 100%;
}

/* 🔹 Kontejner pro název a edit ikonku */
.title-container {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* 🔹 Stylizace tužtičky */
.edit-icon {
  font-size: 1.0rem;
  color: #1976d2;
}

/* 🔹 Při najetí změna barvy */
.edit-icon:hover {
  color: #15c090;
}

/* 🔹 Styling pop-up okna */
.rename-card {
  width: 400px;
  padding: 20px;
}

/* 🔹 Styling dropdownu pro rychlost */
.speed-select {
  width: 100px;
  min-width: 80px;
  padding: 5px;
  border-radius: 10px;
}

/* 🔹 Kontejner pro tlačítko */
.transcription-button-container {
  display: flex;
  justify-content: flex-start;
  padding: 10px 10px;
}
.TranscriptionButton{
  border-radius: 8px;
  padding: 8px 16px;
  
}
.model-card {
  width: 400px;
  padding: 15px;
  border-radius: 12px;
  box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.2);
}

/* 🔹 Hlavička dialogu */
.model-header {
  text-align: center;
  padding-bottom: 0;
}

.model-title {
  font-size: 1.2rem;
  font-weight: bold;
  color: #1976d2;
}
.rename-title {
  font-size: 1.2rem;
  font-weight: bold;
  color: #1976d2;
}

/* 🔹 Možnosti modelů */
.model-body {
  padding: 10px 20px ;
}

.model-options {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* 🔹 Animace při výběru */
.model-options .q-radio {
  transition: transform 0.2s ease-in-out;
}

.model-options .q-radio:active {
  transform: scale(1.1);
}


</style>
